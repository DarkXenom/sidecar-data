name: Sidecar Watchdog

on:
  schedule:
    - cron: "0 * * * *"    # hourly
  workflow_dispatch: {}

jobs:
  check-and-heal:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Check heartbeat age
        id: age
        shell: bash
        run: |
          set -euo pipefail
          URL="https://darkxenom.github.io/sidecar-data/heartbeat.json?ts=$(date +%s)"
          JSON="$(curl -fsSL "$URL" || echo '{}')"

          # Extract ISO timestamp from heartbeat
          VAL="$(printf '%s' "$JSON" | jq -r '.when // .as_of // ""')"

          # Compute age in minutes; if parse fails, mark as very old
          if [ -z "$VAL" ] || ! TS=$(date -d "$VAL" +%s 2>/dev/null); then
            AGE_MIN=999999
          else
            NOW=$(date -u +%s)
            AGE_MIN=$(( (NOW - TS) / 60 ))
          fi

          echo "age_min=${AGE_MIN}"
          echo "age_min=${AGE_MIN}" >> "$GITHUB_OUTPUT"

          if [ "${AGE_MIN}" -gt 1200 ]; then   # > 20 hours
            echo "stale=true"  >> "$GITHUB_OUTPUT"
          else
            echo "stale=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Trigger pipeline if stale (> 20 hours)
        if: steps.age.outputs.stale == 'true'
        env:
          PIPE_PAT: ${{ secrets.SIDECAR_PAT }}
        run: |
          set -euo pipefail
          echo "Dispatching Sidecar-pipeline/build.yml on ref=main ..."
          RESP=$(curl -sS -w "\n%{http_code}\n" -o /tmp/resp.json \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${PIPE_PAT}" \
            -X POST "https://api.github.com/repos/DarkXenom/Sidecar-pipeline/actions/workflows/build.yml/dispatches" \
            -d '{"ref":"main"}')
          CODE=$(tail -n1 <<< "$RESP")
          echo "HTTP ${CODE}"
          echo "Response body:"
          cat /tmp/resp.json || true
          # Success is 204 No Content
          if [ "${CODE}" -ne 204 ]; then
            echo "Dispatch failed (HTTP ${CODE}). Check PAT scopes, repo name, workflow filename/branch." >&2
            exit 1
          fi
          echo "Dispatch OK."
