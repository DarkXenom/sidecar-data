name: Sidecar Watchdog

on:
  schedule:
    - cron: "0 * * * *"   # hourly
  workflow_dispatch: {}

jobs:
  check-and-heal:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check heartbeat age
        id: age
        run: |
          set -euo pipefail
          URL="https://darkxenom.github.io/sidecar-data/heartbeat.json?ts=$(date +%s)"
          JSON="$(curl -fsSL "$URL" || echo '')"
          if [ -z "$JSON" ]; then
            echo "age_min=100000" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          WHEN=$(python - <<'PY'
import json,sys,datetime
j=json.loads(sys.stdin.read())
s=j.get("when") or j.get("as_of") or ""
try:
  # Parse "2025-11-12T16:48+05:30"
  dt=datetime.datetime.fromisoformat(s)
except:
  print(999999); raise SystemExit
now=datetime.datetime.now(datetime.timezone.utc)
if not dt.tzinfo: # assume IST if tz missing
  ist=datetime.timezone(datetime.timedelta(hours=5,minutes=30))
  dt=dt.replace(tzinfo=ist)
age_min=int((now - dt.astimezone(datetime.timezone.utc)).total_seconds()//60)
print(age_min)
PY
<<<"$JSON") || true
          echo "age_min=${WHEN:-999999}" >> "$GITHUB_OUTPUT"

      - name: Trigger pipeline if stale (> 20 hours)
        if: steps.age.outputs.age_min != '' && fromJSON(steps.age.outputs.age_min) > 1200
        env:
          PIPE_PAT: ${{ secrets.SIDECAR_PAT }}
        run: |
          set -euo pipefail
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${PIPE_PAT}" \
            https://api.github.com/repos/DarkXenom/Sidecar-pipeline/actions/workflows/build.yml/dispatches \
            -d '{"ref":"main"}'
