name: Sidecar Watchdog

on:
  schedule:
    - cron: "0 * * * *"    # hourly
  workflow_dispatch: {}

jobs:
  check-and-heal:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check heartbeat age
        id: age
        shell: bash
        run: |
          set -euo pipefail
          URL="https://darkxenom.github.io/sidecar-data/heartbeat.json?ts=$(date +%s)"
          JSON="$(curl -fsSL "$URL" || echo '{}')"

          export HB_JSON="$JSON"
          AGE_MIN=$(python - <<'PY'
import os, json, datetime as dt
j = json.loads(os.environ.get("HB_JSON","{}"))
s = (j.get("when") or j.get("as_of") or "").strip()
try:
    t = dt.datetime.fromisoformat(s)
except Exception:
    print(999999); raise SystemExit
now = dt.datetime.now(dt.timezone.utc)
if t.tzinfo is None:
    ist = dt.timezone(dt.timedelta(hours=5, minutes=30))
    t = t.replace(tzinfo=ist)
age_min = int((now - t.astimezone(dt.timezone.utc)).total_seconds() // 60)
print(age_min)
PY
)
          echo "age_min=${AGE_MIN}" >> "$GITHUB_OUTPUT"
          if [ "${AGE_MIN}" -gt 1200 ]; then   # > 20 hours
            echo "stale=true" >> "$GITHUB_OUTPUT"
          else
            echo "stale=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Trigger pipeline if stale (> 20 hours)
        if: steps.age.outputs.stale == 'true'
        env:
          PIPE_PAT: ${{ secrets.SIDECAR_PAT }}
        run: |
          set -euo pipefail
          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${PIPE_PAT}" \
            https://api.github.com/repos/DarkXenom/Sidecar-pipeline/actions/workflows/build.yml/dispatches \
            -d '{"ref":"main"}'
