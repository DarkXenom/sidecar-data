name: Sidecar Watchdog

on:
  schedule:
    - cron: "0 * * * *"    # hourly
  workflow_dispatch: {}

jobs:
  check-and-heal:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Check heartbeat age
        id: age
        shell: bash
        run: |
          set -euo pipefail
          URL="https://darkxenom.github.io/sidecar-data/heartbeat.json?ts=$(date +%s)"
          JSON="$(curl -fsSL "$URL" || echo '{}')"

          # Extract ISO timestamp from heartbeat
          VAL="$(printf '%s' "$JSON" | jq -r '.when // .as_of // ""')"

          # Compute age in minutes; if parse fails, mark as very old
          if [ -z "$VAL" ] || ! TS=$(date -d "$VAL" +%s 2>/dev/null); then
            AGE_MIN=999999
          else
            NOW=$(date -u +%s)
            AGE_MIN=$(( (NOW - TS) / 60 ))
          fi

          echo "age_min=${AGE_MIN}"
          echo "age_min=${AGE_MIN}" >> "$GITHUB_OUTPUT"

          if [ "${AGE_MIN}" -gt 1200 ]; then   # > 20 hours
            echo "stale=true"  >> "$GITHUB_OUTPUT"
          else
            echo "stale=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Discover workflow id (build.yml) in Sidecar-pipeline
        if: steps.age.outputs.stale == 'true'
        id: wf
        env:
          PIPE_PAT: ${{ secrets.SIDECAR_PAT }}
        run: |
          set -euo pipefail
          OWNER="DarkXenom"
          REPO="Sidecar-pipeline"

          echo "Listing workflows in ${OWNER}/${REPO} ..."
          curl -sS -H "Accept: application/vnd.github+json" \
               -H "Authorization: Bearer ${PIPE_PAT}" \
               "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows" > /tmp/wfs.json

          echo "Available workflows:"
          jq -r '.workflows[] | "\(.id)  \(.name)  \(.path)"' /tmp/wfs.json || true

          # 1) Try to match by file path exactly
          WF_ID=$(jq -r '.workflows[] | select(.path==".github/workflows/build.yml") | .id' /tmp/wfs.json)
          # 2) Fallback: match by name (shown in your workflow as "Build Sidecar Data (Phase A)")
          if [ -z "${WF_ID}" ] || [ "${WF_ID}" = "null" ]; then
            WF_ID=$(jq -r '.workflows[] | select(.name=="Build Sidecar Data (Phase A)") | .id' /tmp/wfs.json)
          fi

          if [ -z "${WF_ID}" ] || [ "${WF_ID}" = "null" ]; then
            echo "ERROR: Could not find workflow id (build.yml or named 'Build Sidecar Data (Phase A)') in ${OWNER}/${REPO}." >&2
            echo "Hint: confirm the filename and the 'name:' in the workflow on the main branch."
            exit 1
          fi

          echo "wf_id=${WF_ID}" >> "$GITHUB_OUTPUT"

      - name: Trigger pipeline by workflow id (if stale)
        if: steps.age.outputs.stale == 'true'
        env:
          PIPE_PAT: ${{ secrets.SIDECAR_PAT }}
        run: |
          set -euo pipefail
          OWNER="DarkXenom"
          REPO="Sidecar-pipeline"
          WF_ID="${{ steps.wf.outputs.wf_id }}"

          echo "Dispatching workflow id=${WF_ID} on ref=main ..."
          RESP=$(curl -sS -w "\n%{http_code}\n" -o /tmp/resp.json \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${PIPE_PAT}" \
            -X POST "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WF_ID}/dispatches" \
            -d '{"ref":"main"}')
          CODE=$(tail -n1 <<< "$RESP")
          echo "HTTP ${CODE}"
          echo "Response body:"; cat /tmp/resp.json || true

          # Success is 204 No Content
          if [ "${CODE}" -ne 204 ]; then
            echo "Dispatch failed (HTTP ${CODE}). Likely causes:" >&2
            echo " - Wrong branch (ref) or workflow not on 'main'." >&2
            echo " - Token lacks Actions/Contents write on ${OWNER}/${REPO}." >&2
            echo " - Workflow file is named differently or on another path." >&2
            exit 1
          fi

          echo "Dispatch OK."

